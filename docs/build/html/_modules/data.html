

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>data &mdash; nczarr-viewer 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
    <link rel="canonical" href="/nczarr-viewer/_modules/data.html" />
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/custom.js"></script>
      <script src="../_static/redirect.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #667eea" >

          
          
          <a href="../index.html" class="icon icon-home">
            nczarr-viewer
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#quick-start">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#local-development">Local Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#docker-deployment">Docker Deployment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../usage.html#quick-docker-run">Quick Docker Run</a></li>
<li class="toctree-l3"><a class="reference internal" href="../usage.html#with-local-files">With Local Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../usage.html#with-online-datasets">With Online Datasets</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#s3-cloud-storage-access">S3/Cloud Storage Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#cmems-integration">CMEMS Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dockerfile.html">Dockerfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api.html#module-main">Core Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api.html#main.TimeoutException"><code class="docutils literal notranslate"><span class="pre">TimeoutException</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api.html#main.ViewerApp"><code class="docutils literal notranslate"><span class="pre">ViewerApp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#main.ViewerApp.get_metadata_summary"><code class="docutils literal notranslate"><span class="pre">ViewerApp.get_metadata_summary()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#main.ViewerApp.run"><code class="docutils literal notranslate"><span class="pre">ViewerApp.run()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#main.ViewerApp.setup_callbacks"><code class="docutils literal notranslate"><span class="pre">ViewerApp.setup_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#main.ViewerApp.setup_help_modal_callback"><code class="docutils literal notranslate"><span class="pre">ViewerApp.setup_help_modal_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#main.ViewerApp.setup_variable_metadata_callback"><code class="docutils literal notranslate"><span class="pre">ViewerApp.setup_variable_metadata_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#main.ViewerApp.update_variable_dropdown"><code class="docutils literal notranslate"><span class="pre">ViewerApp.update_variable_dropdown()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#module-data">Data Loading and Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api.html#data.DataManager"><code class="docutils literal notranslate"><span class="pre">DataManager</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DataManager.create_raster_image"><code class="docutils literal notranslate"><span class="pre">DataManager.create_raster_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DataManager.setup_callbacks"><code class="docutils literal notranslate"><span class="pre">DataManager.setup_callbacks()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api.html#data.DataPlot"><code class="docutils literal notranslate"><span class="pre">DataPlot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DataPlot.setup_callbacks"><code class="docutils literal notranslate"><span class="pre">DataPlot.setup_callbacks()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api.html#data.DataQuickStats"><code class="docutils literal notranslate"><span class="pre">DataQuickStats</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DataQuickStats.setup_callbacks"><code class="docutils literal notranslate"><span class="pre">DataQuickStats.setup_callbacks()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api.html#data.DataSubsetter"><code class="docutils literal notranslate"><span class="pre">DataSubsetter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DataSubsetter.subset_data"><code class="docutils literal notranslate"><span class="pre">DataSubsetter.subset_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api.html#data.DatasetLoader"><code class="docutils literal notranslate"><span class="pre">DatasetLoader</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DatasetLoader.clear_logs"><code class="docutils literal notranslate"><span class="pre">DatasetLoader.clear_logs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DatasetLoader.get_logs"><code class="docutils literal notranslate"><span class="pre">DatasetLoader.get_logs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DatasetLoader.load_dataset"><code class="docutils literal notranslate"><span class="pre">DatasetLoader.load_dataset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#data.DatasetLoader.setup_logging"><code class="docutils literal notranslate"><span class="pre">DatasetLoader.setup_logging()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#variable-and-dimension-handling">Variable and Dimension Handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api.html#variables.VariableSelection"><code class="docutils literal notranslate"><span class="pre">VariableSelection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#variables.VariableSelection.setup_callbacks"><code class="docutils literal notranslate"><span class="pre">VariableSelection.setup_callbacks()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api.html#dimension.DimensionSelection"><code class="docutils literal notranslate"><span class="pre">DimensionSelection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api.html#dimension.DimensionSelection.create_dropdown"><code class="docutils literal notranslate"><span class="pre">DimensionSelection.create_dropdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#dimension.DimensionSelection.create_range_slider"><code class="docutils literal notranslate"><span class="pre">DimensionSelection.create_range_slider()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#dimension.DimensionSelection.generate_dimension_checklist"><code class="docutils literal notranslate"><span class="pre">DimensionSelection.generate_dimension_checklist()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#dimension.DimensionSelection.generate_dimension_controls"><code class="docutils literal notranslate"><span class="pre">DimensionSelection.generate_dimension_controls()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api.html#dimension.DimensionSelection.setup_callbacks"><code class="docutils literal notranslate"><span class="pre">DimensionSelection.setup_callbacks()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#main-application-class">Main Application Class</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #667eea" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nczarr-viewer</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for data</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dash</span><span class="w"> </span><span class="kn">import</span> <span class="n">Output</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">dcc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dash_bootstrap_components</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dbc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>


<div class="viewcode-block" id="DatasetLoader">
<a class="viewcode-back" href="../api.html#data.DatasetLoader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DatasetLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles dataset loading with multiple backends and error handling&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_backends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_backends</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_backends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect available backends for dataset loading&quot;&quot;&quot;</span>
        <span class="n">backends</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;xarray&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;engines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;netcdf4&#39;</span><span class="p">,</span> <span class="s1">&#39;zarr&#39;</span><span class="p">],</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Standard xarray engines&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Check for specialized backends</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">copernicusmarine</span>  <span class="c1"># noqa: F401</span>
            <span class="n">backends</span><span class="p">[</span><span class="s1">&#39;copernicusmarine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;engines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;custom_open_zarr&#39;</span><span class="p">],</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Copernicus Marine Service backend&#39;</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">pydap</span>  <span class="c1"># noqa: F401</span>
            <span class="n">backends</span><span class="p">[</span><span class="s1">&#39;pydap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;engines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pydap&#39;</span><span class="p">],</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;OPeNDAP backend&#39;</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>  <span class="c1"># noqa: F401</span>
            <span class="n">backends</span><span class="p">[</span><span class="s1">&#39;rasterio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;engines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rasterio&#39;</span><span class="p">],</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Raster backend&#39;</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">backends</span>

<div class="viewcode-block" id="DatasetLoader.setup_logging">
<a class="viewcode-back" href="../api.html#data.DatasetLoader.setup_logging">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup logging to capture output&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">),</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>  <span class="c1"># Also show in terminal</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatasetLoader.clear_logs">
<a class="viewcode-back" href="../api.html#data.DatasetLoader.clear_logs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the log output buffer&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatasetLoader.get_logs">
<a class="viewcode-back" href="../api.html#data.DatasetLoader.get_logs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current log output&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>


<div class="viewcode-block" id="DatasetLoader.load_dataset">
<a class="viewcode-back" href="../api.html#data.DatasetLoader.load_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;xarray&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load dataset with specified backend and engine</span>

<span class="sd">        Args:</span>
<span class="sd">            url: Dataset URL or path</span>
<span class="sd">            backend: Backend to use (&#39;xarray&#39;, &#39;copernicusmarine&#39;, etc.)</span>
<span class="sd">            engine: Engine to use with the backend</span>
<span class="sd">            **kwargs: Additional arguments passed to the dataset loader</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_logs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to load dataset: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend: </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">, Engine: </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Additional kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;xarray&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_with_xarray</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;copernicusmarine&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_with_copernicusmarine</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown backend: </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traceback: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_with_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load dataset using xarray&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading with xarray, engine: </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="c1"># Auto-detect engine based on URL</span>
            <span class="k">if</span> <span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s1">&#39;.nc4&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;netcdf4&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;.zarr&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;zarr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;netcdf4&#39;</span>  <span class="c1"># Default</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected engine: </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Try to open with selected engine</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter out only backend and engine from kwargs to avoid conflicts</span>
            <span class="c1"># All other xarray parameters (including decode_timedelta) are passed through</span>
            <span class="n">xarray_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">,</span> <span class="s1">&#39;backend&#39;</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Passing kwargs to xarray: </span><span class="si">{</span><span class="n">xarray_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">xarray_kwargs</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully opened dataset with </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset shape: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data variables: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ds</span><span class="p">,</span> <span class="n">engine</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed with engine </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Try alternative engines if the first one fails</span>
            <span class="n">alternative_engines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;netcdf4&#39;</span><span class="p">,</span> <span class="s1">&#39;zarr&#39;</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">engine</span> <span class="ow">in</span> <span class="n">alternative_engines</span><span class="p">:</span>
                <span class="n">alternative_engines</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">alt_engine</span> <span class="ow">in</span> <span class="n">alternative_engines</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Trying alternative engine: </span><span class="si">{</span><span class="n">alt_engine</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
                        <span class="n">url</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">alt_engine</span><span class="p">,</span> <span class="o">**</span><span class="n">xarray_kwargs</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Successfully opened with alternative engine: </span><span class="si">{</span><span class="n">alt_engine</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">ds</span><span class="p">,</span> <span class="n">alt_engine</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">alt_e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Alternative engine </span><span class="si">{</span><span class="n">alt_engine</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">alt_e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Provide helpful error message with tips</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;All engines failed. Last error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add specific help for common issues</span>
            <span class="k">if</span> <span class="s2">&quot;netcdf4&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;netcdf&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">ðŸ’¡ NetCDF loading failed. Try these solutions:&quot;</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â€¢ For netcdf files on s3 storage: Add #mode=bytes at the end of the URL&quot;</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â€¢ Check if the file is corrupted or incomplete&quot;</span>
            
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_with_copernicusmarine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load dataset using copernicusmarine backend&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading with copernicusmarine, engine: </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># For custom_open_zarr engine, we don&#39;t need credentials</span>
        <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;custom_open_zarr.open_zarr&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">copernicusmarine.core_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">custom_open_zarr</span>
                <span class="c1"># Try to open the store and then open it as a dataset</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;opening dataset with custom_open_zarr.open_zarr and </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># The custom_open_zarr.open_zarr function accepts:</span>
                <span class="c1"># - dataset_url (positional)</span>
                <span class="c1"># - copernicus_marine_username (optional)</span>
                <span class="c1"># - **kwargs (which get passed to xarray.open_zarr)</span>

                <span class="c1"># Filter out copernicusmarine-specific parameters</span>
                <span class="n">zarr_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_id&#39;</span><span class="p">]}</span>

                <span class="c1"># Set S3 client configuration through environment variables</span>
                <span class="c1"># This is more reliable than passing through storage_options</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="s1">&#39;AWS_MAX_POOL_CONNECTIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;20&#39;</span><span class="p">)</span>  <span class="c1"># Increased from 10</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;AWS_RETRY_MODE&#39;</span><span class="p">,</span> <span class="s1">&#39;adaptive&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;AWS_MAX_ATTEMPTS&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>  <span class="c1"># Increased</span>
                <span class="c1"># Increased from 60 to 120</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;AWS_CONNECT_TIMEOUT&#39;</span><span class="p">,</span> <span class="s1">&#39;120&#39;</span><span class="p">)</span>
                <span class="c1"># Increased from 120 to 300</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;AWS_READ_TIMEOUT&#39;</span><span class="p">,</span> <span class="s1">&#39;300&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;AWS_S3_ADDRESSING_STYLE&#39;</span><span class="p">,</span> <span class="s1">&#39;virtual&#39;</span><span class="p">)</span>

                <span class="c1"># Debug: Print current environment variables</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;DEBUG: AWS_MAX_POOL_CONNECTIONS = </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AWS_MAX_POOL_CONNECTIONS&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;DEBUG: AWS_RETRY_MODE = </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AWS_RETRY_MODE&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;DEBUG: AWS_MAX_ATTEMPTS = </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AWS_MAX_ATTEMPTS&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Pass user kwargs to custom_open_zarr.open_zarr</span>
                <span class="c1"># The environment variables will configure the S3 client</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">custom_open_zarr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">zarr_kwargs</span><span class="p">)</span>

                <span class="c1"># Debug: Check if dataset has any S3-related attributes</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Dataset type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;_file_obj&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Dataset has _file_obj: </span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">_file_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Dataset encoding: </span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">encoding</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Debug: Try to access a small piece of data to trigger S3 operations</span>
                <span class="c1"># This will help us see what connection parameters are being used</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;data_vars&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">var_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;DEBUG: Attempting to access variable: </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Get just the first element to minimize data transfer</span>
                        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span>
                            <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">})</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;DEBUG: Successfully accessed sample data: </span><span class="si">{</span><span class="n">sample_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;DEBUG: This should have triggered S3 operations with our connection settings&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: No data variables found in dataset&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Error during data access: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Error type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Dataset loaded successfully&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset: </span><span class="si">{</span><span class="n">ds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully opened with custom_open_zarr&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ds</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;copernicusmarine_custom_open_zarr&quot;</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;copernicusmarine not available&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;custom_open_zarr failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># For other engines, extract copernicusmarine-specific parameters</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;copernicusmarine requires &#39;username&#39; and &#39;password&#39; in backend args&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_id</span><span class="p">:</span>
            <span class="c1"># If no dataset_id provided, try to use the URL as dataset_id</span>
            <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No dataset_id provided, using URL as dataset_id: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using dataset_id: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Username: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">copernicusmarine</span>

            <span class="c1"># Filter out copernicusmarine-specific parameters to avoid duplicates</span>
            <span class="n">filtered_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_id&#39;</span><span class="p">]}</span>

            <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="c1"># Use copernicusmarine.open_dataset with dataset_id</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">copernicusmarine</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
                    <span class="n">dataset_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered_kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown copernicusmarine engine: </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully opened with copernicusmarine&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ds</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;copernicusmarine_</span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;copernicusmarine not available&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;copernicusmarine failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataManager">
<a class="viewcode-back" href="../api.html#data.DataManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified data management class that handles subsetting, statistics, and plotting.</span>
<span class="sd">    This consolidates the previously scattered functionality into a clean, simple API.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">dataset_getter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="c1"># Function that returns the current dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_getter</span> <span class="o">=</span> <span class="n">dataset_getter</span>

<div class="viewcode-block" id="DataManager.setup_callbacks">
<a class="viewcode-back" href="../api.html#data.DataManager.setup_callbacks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup all data-related callbacks in one place&quot;&quot;&quot;</span>

        <span class="c1"># Callback for quick statistics</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;data-array-display&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;show-data-button&#39;</span><span class="p">,</span> <span class="s1">&#39;n_clicks&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;variable-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;selected-dimensions-store&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;data-filter-min&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;data-filter-max&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">show_quick_stats</span><span class="p">(</span><span class="n">n_clicks</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">,</span> <span class="n">selected_dims</span><span class="p">,</span> <span class="n">filter_min</span><span class="p">,</span> <span class="n">filter_max</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Display quick statistics for the selected data&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">n_clicks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_clicks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Click &#39;Show Data Quick Stats&#39; to see statistics&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_var</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">selected_dims</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Please select a variable and dimensions first&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get subsetted data</span>
                <span class="n">subsetted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subsetted_data</span><span class="p">(</span>
                    <span class="n">selected_var</span><span class="p">,</span> <span class="n">selected_dims</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subsetted_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Error: Could not subset data&quot;</span>

                <span class="c1"># Calculate and display statistics</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_statistics</span><span class="p">(</span>
                    <span class="n">subsetted_data</span><span class="p">,</span> <span class="n">filter_min</span><span class="p">,</span> <span class="n">filter_max</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Error: Could not calculate statistics&quot;</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_statistics_display</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>



        <span class="c1"># Callback for extracting image and showing in separate container</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;raster-container&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;extract-plot-button&#39;</span><span class="p">,</span> <span class="s1">&#39;n_clicks&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;variable-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;selected-dimensions-store&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;data-filter-min&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s1">&#39;data-filter-max&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">extract_image</span><span class="p">(</span><span class="n">n_clicks</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">,</span> <span class="n">selected_dims</span><span class="p">,</span> <span class="n">filter_min</span><span class="p">,</span> <span class="n">filter_max</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate raster image and display in sidebar&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== EXTRACT IMAGE CALLBACK TRIGGERED ===&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_clicks: </span><span class="si">{</span><span class="n">n_clicks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;selected_var: </span><span class="si">{</span><span class="n">selected_var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;selected_dims: </span><span class="si">{</span><span class="n">selected_dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filter_min: </span><span class="si">{</span><span class="n">filter_min</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filter_max: </span><span class="si">{</span><span class="n">filter_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">n_clicks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_clicks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clicks detected, returning empty&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_var</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">selected_dims</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing variable or dimensions, returning message&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;Please select a variable and dimensions first&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-muted text-center&quot;</span><span class="p">)]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting subsetted data...&quot;</span><span class="p">)</span>
                <span class="c1"># Get subsetted data</span>
                <span class="n">subsetted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subsetted_data</span><span class="p">(</span>
                    <span class="n">selected_var</span><span class="p">,</span> <span class="n">selected_dims</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subsetted_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;Error: Could not subset data&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-danger text-center&quot;</span><span class="p">)]</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding spatial dimensions...&quot;</span><span class="p">)</span>
                <span class="c1"># Find spatial dimensions</span>
                <span class="n">lat_dim</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">lon_dim</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">subsetted_data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">dim_lower</span> <span class="o">=</span> <span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;lat&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span> <span class="ow">or</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span><span class="p">:</span>
                        <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">dim</span>
                    <span class="k">elif</span> <span class="s1">&#39;lon&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span> <span class="ow">or</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span><span class="p">:</span>
                        <span class="n">lon_dim</span> <span class="o">=</span> <span class="n">dim</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">lat_dim</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lon_dim</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;Error: No spatial dimensions found&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-danger text-center&quot;</span><span class="p">)]</span>

                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Creating raster image with lat_dim=</span><span class="si">{</span><span class="n">lat_dim</span><span class="si">}</span><span class="s2">, lon_dim=</span><span class="si">{</span><span class="n">lon_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Create raster image</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_raster_image</span><span class="p">(</span>
                    <span class="n">subsetted_data</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Storing data for overlay...&quot;</span><span class="p">)</span>
                <span class="c1"># Store the current variable and image data for overlay button</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_raster_var</span> <span class="o">=</span> <span class="n">selected_var</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_raster_data</span> <span class="o">=</span> <span class="n">subsetted_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_lat_dim</span> <span class="o">=</span> <span class="n">lat_dim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_lon_dim</span> <span class="o">=</span> <span class="n">lon_dim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_raster_image</span> <span class="o">=</span> <span class="n">image_path</span>  <span class="c1"># This is now base64 data</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating full-width raster display...&quot;</span><span class="p">)</span>
                <span class="c1"># Create container with base64 image for full-width display</span>
                <span class="n">container_content</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">H4</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ðŸ“Š </span><span class="si">{</span><span class="n">selected_var</span><span class="si">}</span><span class="s2"> - Raster Analysis&quot;</span><span class="p">,</span> 
                               <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-center mb-3 text-primary&quot;</span><span class="p">),</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">Img</span><span class="p">(</span>
                            <span class="n">src</span><span class="o">=</span><span class="n">image_path</span><span class="p">,</span>  <span class="c1"># This is now base64 data</span>
                            <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;100%&#39;</span><span class="p">,</span> 
                                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;maxWidth&#39;</span><span class="p">:</span> <span class="s1">&#39;1200px&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;margin&#39;</span><span class="p">:</span> <span class="s1">&#39;0 auto&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;borderRadius&#39;</span><span class="p">:</span> <span class="s1">&#39;8px&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;boxShadow&#39;</span><span class="p">:</span> <span class="s1">&#39;0 4px 8px rgba(0,0,0,0.1)&#39;</span>
                            <span class="p">},</span>
                            <span class="n">className</span><span class="o">=</span><span class="s2">&quot;raster-image&quot;</span>
                        <span class="p">),</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                            <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;âœ… Image generated successfully!&quot;</span><span class="p">,</span> 
                                   <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-success text-center mt-3 mb-2&quot;</span><span class="p">,</span> 
                                   <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontSize&#39;</span><span class="p">:</span> <span class="s1">&#39;14px&#39;</span><span class="p">,</span> <span class="s1">&#39;fontWeight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">}),</span>
                            <span class="n">dbc</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;ðŸ—ºï¸ Overlay on World Map&#39;</span><span class="p">,</span> 
                                       <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;overlay-button&#39;</span><span class="p">,</span>
                                       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> 
                                       <span class="n">size</span><span class="o">=</span><span class="s1">&#39;lg&#39;</span><span class="p">,</span> 
                                       <span class="n">className</span><span class="o">=</span><span class="s1">&#39;mx-auto d-block&#39;</span><span class="p">)</span>
                        <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-center&quot;</span><span class="p">)</span>
                    <span class="p">])</span>
                <span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Returning container content successfully!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">container_content</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in extract_image: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;text-danger text-center&quot;</span><span class="p">)]</span>

        <span class="c1"># Callback for overlaying image on world map</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Output</span><span class="p">(</span><span class="s1">&#39;map-container&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">allow_duplicate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;map-container&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="n">allow_duplicate</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
            <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;overlay-button&#39;</span><span class="p">,</span> <span class="s1">&#39;n_clicks&#39;</span><span class="p">),</span>
            <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">overlay_on_map</span><span class="p">(</span><span class="n">n_clicks</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Overlay the generated raster image on the world map&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== OVERLAY CALLBACK TRIGGERED ===&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_clicks: </span><span class="si">{</span><span class="n">n_clicks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">n_clicks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_clicks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clicks detected&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;Click &#39;Overlay on Map&#39; to see the result&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking for stored raster data...&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_raster_var&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No current_raster_var found&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s2">&quot;Error: No raster image generated yet&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>

                <span class="c1"># Get the stored data</span>
                <span class="n">selected_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_raster_var</span>
                <span class="n">subsetted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_raster_data</span>
                <span class="n">lat_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lat_dim</span>
                <span class="n">lon_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lon_dim</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored data - var: </span><span class="si">{</span><span class="n">selected_var</span><span class="si">}</span><span class="s2">, lat_dim: </span><span class="si">{</span><span class="n">lat_dim</span><span class="si">}</span><span class="s2">, lon_dim: </span><span class="si">{</span><span class="n">lon_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subsetted data shape: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">subsetted_data</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Get the stored base64 image data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_raster_image&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No current_raster_image found&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s2">&quot;Error: No raster image data found&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>

                <span class="n">image_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_raster_image</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image source type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">image_src</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image source length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_src</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">image_src</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating world map with overlay...&quot;</span><span class="p">)</span>
                <span class="c1"># Create world map with overlay</span>
                <span class="n">overlay_figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_world_map_with_overlay</span><span class="p">(</span>
                    <span class="n">selected_var</span><span class="p">,</span> <span class="n">subsetted_data</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">overlay_figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlay figure creation failed&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s2">&quot;Error: Could not create overlay&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlay figure created successfully, returning...&quot;</span><span class="p">)</span>
                
                <span class="c1"># Return the Plotly figure in a Graph component</span>
                <span class="k">return</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">overlay_figure</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;displayModeBar&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;scrollZoom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;block&#39;</span><span class="p">}</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in overlay_on_map: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_subsetted_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">,</span> <span class="n">selected_dims</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get subsetted data based on user selections&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_getter</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">variable_data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">selected_var</span><span class="p">]</span>

            <span class="c1"># Apply dimension selections</span>
            <span class="k">if</span> <span class="n">selected_dims</span><span class="p">:</span>
                <span class="c1"># Handle different types of selections</span>
                <span class="n">isel_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># For integer-based indexing</span>
                <span class="n">sel_dict</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># For label-based selection</span>

                <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">selected_dims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dim: </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">, val: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Debug: show coordinate values and their order</span>
                    <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">variable_data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                        <span class="n">coords_vals</span> <span class="o">=</span> <span class="n">variable_data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2"> coords: </span><span class="si">{</span><span class="n">coords_vals</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">... (length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords_vals</span><span class="p">)</span><span class="si">}</span><span class="s2">, ascending: </span><span class="si">{</span><span class="n">coords_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">coords_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Range selection (start, end) - use slice for array subsetting</span>
                            <span class="n">start_val</span><span class="p">,</span> <span class="n">end_val</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="c1"># Find indices for the start and end values</span>
                            <span class="n">dim_coords</span> <span class="o">=</span> <span class="n">variable_data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                            <span class="c1"># Handle different coordinate types</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dim_coords</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
                                <span class="c1"># For datetime coordinates, convert to numpy datetime64 for comparison</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                    <span class="n">start_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">start_val</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                    <span class="n">end_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">end_val</span><span class="p">)</span>

                            <span class="c1"># Find the range of coordinates that fall within the user&#39;s selection</span>
                            <span class="c1"># This handles both ascending and descending coordinate arrays correctly</span>
                            <span class="n">min_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="n">end_val</span><span class="p">)</span>
                            <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="n">end_val</span><span class="p">)</span>
                            
                            <span class="c1"># Find indices where coordinates fall within the range</span>
                            <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_coords</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dim_coords</span> <span class="o">&lt;=</span> <span class="n">max_val</span><span class="p">)</span>
                            <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                
                                <span class="c1"># Create slice - this preserves the original coordinate order</span>
                                <span class="n">isel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created slice for </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (from values </span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Fallback: use searchsorted approach</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">,</span> <span class="n">min_val</span><span class="p">)</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
                                
                                <span class="c1"># Ensure we don&#39;t go out of bounds</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">end_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="c1"># Convert numpy types to Python types for slice</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_idx</span><span class="p">)</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_idx</span><span class="p">)</span>
                                
                                <span class="c1"># Ensure slice indices are in correct order for Python slicing</span>
                                <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;</span> <span class="n">end_idx</span><span class="p">:</span>
                                    <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">end_idx</span><span class="p">,</span> <span class="n">start_idx</span>
                                
                                <span class="c1"># Create slice</span>
                                <span class="n">isel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created slice for </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (from values </span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Single selection (val,) - use exact value selection</span>
                            <span class="n">sel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="c1"># Handle list format (fallback for old dimension selection)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Range selection [start, end] - convert to tuple format</span>
                            <span class="n">start_val</span><span class="p">,</span> <span class="n">end_val</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="c1"># Handle timestamp conversion for time dimension</span>
                            <span class="k">if</span> <span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                                <span class="c1"># Convert nanosecond timestamp to datetime</span>
                                <span class="n">start_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>
                                <span class="n">end_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">end_val</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>

                            <span class="c1"># Find indices for the start and end values</span>
                            <span class="n">dim_coords</span> <span class="o">=</span> <span class="n">variable_data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                            
                            <span class="c1"># Find the range of coordinates that fall within the user&#39;s selection</span>
                            <span class="c1"># This handles both ascending and descending coordinate arrays correctly</span>
                            <span class="n">min_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="n">end_val</span><span class="p">)</span>
                            <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="n">end_val</span><span class="p">)</span>
                            
                            <span class="c1"># Find indices where coordinates fall within the range</span>
                            <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_coords</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dim_coords</span> <span class="o">&lt;=</span> <span class="n">max_val</span><span class="p">)</span>
                            <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                
                                <span class="c1"># Create slice - this preserves the original coordinate order</span>
                                <span class="n">isel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created slice for </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (from values </span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Fallback: use searchsorted approach</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">,</span> <span class="n">min_val</span><span class="p">)</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
                                
                                <span class="c1"># Ensure we don&#39;t go out of bounds</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">end_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="c1"># Convert numpy types to Python types for slice</span>
                                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_idx</span><span class="p">)</span>
                                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_idx</span><span class="p">)</span>
                                
                                <span class="c1"># Ensure slice indices are in correct order for Python slicing</span>
                                <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;</span> <span class="n">end_idx</span><span class="p">:</span>
                                    <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">end_idx</span><span class="p">,</span> <span class="n">start_idx</span>
                                
                                <span class="c1"># Create slice</span>
                                <span class="n">isel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created slice for </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (from values </span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Single selection [val] - convert to tuple format</span>
                            <span class="n">single_val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Handle timestamp conversion for time dimension</span>
                            <span class="k">if</span> <span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">single_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                                <span class="n">single_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">single_val</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>
                            <span class="n">sel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_val</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="c1"># Direct value selection</span>
                        <span class="n">sel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Fallback for other types</span>
                        <span class="n">sel_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                <span class="c1"># Apply integer-based selections first</span>
                <span class="k">if</span> <span class="n">isel_dict</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying integer-based selections: </span><span class="si">{</span><span class="n">isel_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">selected_data</span> <span class="o">=</span> <span class="n">variable_data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="o">**</span><span class="n">isel_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selected_data</span> <span class="o">=</span> <span class="n">variable_data</span>

                <span class="c1"># Apply label-based selections</span>
                <span class="k">if</span> <span class="n">sel_dict</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying label-based selections: </span><span class="si">{</span><span class="n">sel_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">selected_data</span> <span class="o">=</span> <span class="n">selected_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">sel_dict</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">selected_var</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">selected_dims</span><span class="p">:</span>
                <span class="n">selected_data</span> <span class="o">=</span> <span class="n">variable_data</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;selected_data shape: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">selected_data</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">selected_data</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error subsetting data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">filter_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate basic statistics from a data array&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Get values and convert to numpy array</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># Convert timedelta64 or datetime64 to float for stats</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[h]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[D]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

            <span class="c1"># Apply filters if set</span>
            <span class="k">if</span> <span class="n">filter_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span> <span class="o">&lt;</span> <span class="n">filter_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filter_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span> <span class="o">&gt;</span> <span class="n">filter_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="c1"># Calculate statistics</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">))),</span>
                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">stats</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating statistics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_statistics_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format statistics for display&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No statistics available&quot;</span>

        <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
            <span class="n">html</span><span class="o">.</span><span class="n">H6</span><span class="p">(</span><span class="s2">&quot;Data Statistics&quot;</span><span class="p">,</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;mb-3&quot;</span><span class="p">),</span>
            <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Strong</span><span class="p">(</span><span class="s2">&quot;Min: &quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;me-4&quot;</span><span class="p">),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Strong</span><span class="p">(</span><span class="s2">&quot;Max: &quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;me-4&quot;</span><span class="p">),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Strong</span><span class="p">(</span><span class="s2">&quot;Mean: &quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;me-4&quot;</span><span class="p">),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Strong</span><span class="p">(</span><span class="s2">&quot;Median: &quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;me-4&quot;</span><span class="p">),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Strong</span><span class="p">(</span><span class="s2">&quot;Std: &quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;me-4&quot;</span><span class="p">),</span>
            <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;d-flex flex-wrap&quot;</span><span class="p">),</span>
            <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Small</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Valid values: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">],</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;mt-2 text-muted&quot;</span><span class="p">)</span>
        <span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">filter_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a plot from the data array&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Get coordinate information</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coords: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dims: </span><span class="si">{</span><span class="n">dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_array: </span><span class="si">{</span><span class="n">data_array</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;variable_name: </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filter_min: </span><span class="si">{</span><span class="n">filter_min</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filter_max: </span><span class="si">{</span><span class="n">filter_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Find spatial dimensions</span>
            <span class="n">lat_dim</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lon_dim</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
                <span class="n">dim_lower</span> <span class="o">=</span> <span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;lat&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span> <span class="ow">or</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span><span class="p">:</span>
                    <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">dim</span>
                <span class="k">elif</span> <span class="s1">&#39;lon&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span> <span class="ow">or</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">dim_lower</span><span class="p">:</span>
                    <span class="n">lon_dim</span> <span class="o">=</span> <span class="n">dim</span>

            <span class="c1"># Get data values</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># Convert timedelta64 or datetime64 to float for plotting</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[h]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[D]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

            <span class="c1"># Apply filters</span>
            <span class="k">if</span> <span class="n">filter_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span> <span class="o">&lt;</span> <span class="n">filter_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filter_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span> <span class="o">&gt;</span> <span class="n">filter_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="c1"># Handle different data dimensions</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># 1D data - create line plot</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_1d_plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">lat_dim</span> <span class="ow">and</span> <span class="n">lon_dim</span><span class="p">:</span>
                <span class="c1"># 2D spatial data - create heatmap</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_2d_heatmap</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback for other cases</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fallback_plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_1d_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a 1D line plot&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Use the first coordinate for x-axis</span>
        <span class="n">x_coord</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">x_coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Convert datetime64 to string for plotting if needed</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">x_values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
            <span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_values</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_values</span> <span class="o">=</span> <span class="n">x_values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Ensure values is also a list</span>
        <span class="n">y_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_values</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+markers&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">x_coord</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="n">x_coord</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_white&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_2d_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a 2D heatmap using Plotly&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating 2D heatmap...&quot;</span><span class="p">)</span>

        <span class="n">lats</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lat_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lon_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Ensure proper alignment</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># For very large datasets, downsample for performance</span>
        <span class="n">max_resolution</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># Keep it manageable</span>
        <span class="k">if</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_resolution</span> <span class="ow">or</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_resolution</span><span class="p">:</span>
            <span class="n">lat_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">max_resolution</span><span class="p">)</span>
            <span class="n">lon_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">max_resolution</span><span class="p">)</span>

            <span class="n">values_downsampled</span> <span class="o">=</span> <span class="n">values</span><span class="p">[::</span><span class="n">lat_factor</span><span class="p">,</span> <span class="p">::</span><span class="n">lon_factor</span><span class="p">]</span>
            <span class="n">lats_downsampled</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[::</span><span class="n">lat_factor</span><span class="p">]</span>
            <span class="n">lons_downsampled</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[::</span><span class="n">lon_factor</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Downsampled from </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">values_downsampled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values_downsampled</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">lats_downsampled</span> <span class="o">=</span> <span class="n">lats</span>
            <span class="n">lons_downsampled</span> <span class="o">=</span> <span class="n">lons</span>

        <span class="c1"># Create the heatmap</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">values_downsampled</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">lons_downsampled</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">lats_downsampled</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Viridis&#39;</span><span class="p">,</span>
            <span class="n">hoverongaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;%</span><span class="si">{y:.3f}</span><span class="s1">Â°N, %</span><span class="si">{x:.3f}</span><span class="s1">Â°E&lt;/b&gt;&lt;br&gt;&#39;</span> <span class="o">+</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s1">: %</span><span class="se">{{</span><span class="s1">z:.3g</span><span class="se">}}</span><span class="s1">&lt;br&gt;&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span>
                <span class="nb">len</span><span class="o">=</span><span class="mf">0.8</span>
            <span class="p">)</span>
        <span class="p">))</span>

        <span class="c1"># Update layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> Heatmap&quot;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2c3e50&#39;</span><span class="p">),</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span>
            <span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D heatmap created successfully!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>



<div class="viewcode-block" id="DataManager.create_raster_image">
<a class="viewcode-back" href="../api.html#data.DataManager.create_raster_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_raster_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a raster image from the data array and save it&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating raster image...&quot;</span><span class="p">)</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

        <span class="n">lats</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lat_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lon_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">values</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Latitude range: </span><span class="si">{</span><span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Longitude range: </span><span class="si">{</span><span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Values shape: </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure proper alignment</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># For large datasets, downsample for performance but keep higher resolution</span>
        <span class="n">max_resolution</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Increased from 800 for much better quality</span>
        <span class="k">if</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_resolution</span> <span class="ow">or</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_resolution</span><span class="p">:</span>
            <span class="n">lat_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">max_resolution</span><span class="p">)</span>
            <span class="n">lon_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">max_resolution</span><span class="p">)</span>

            <span class="n">values_downsampled</span> <span class="o">=</span> <span class="n">values</span><span class="p">[::</span><span class="n">lat_factor</span><span class="p">,</span> <span class="p">::</span><span class="n">lon_factor</span><span class="p">]</span>
            <span class="n">lats_downsampled</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[::</span><span class="n">lat_factor</span><span class="p">]</span>
            <span class="n">lons_downsampled</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[::</span><span class="n">lon_factor</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Downsampled from </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">values_downsampled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values_downsampled</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">lats_downsampled</span> <span class="o">=</span> <span class="n">lats</span>
            <span class="n">lons_downsampled</span> <span class="o">=</span> <span class="n">lons</span>

        <span class="c1"># Handle latitude orientation - ensure north is at the top</span>
        <span class="c1"># If latitude coordinates are ascending (-90 to 90), flip the data vertically</span>
        <span class="c1"># so that north (90) appears at the top of the image</span>
        <span class="k">if</span> <span class="n">lats_downsampled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lats_downsampled</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># Ascending order</span>
            <span class="n">values_display</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">values_downsampled</span><span class="p">)</span>
            <span class="n">lat_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">lats_downsampled</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">lats_downsampled</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>  <span class="c1"># Reverse extent</span>
            <span class="n">lats_for_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">lats_downsampled</span><span class="p">)</span>  <span class="c1"># Flip coords to match flipped data</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Latitude coordinates are ascending, flipping data vertically for correct display&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Descending order (90 to -90)</span>
            <span class="n">values_display</span> <span class="o">=</span> <span class="n">values_downsampled</span>
            <span class="n">lat_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">lats_downsampled</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lats_downsampled</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
            <span class="n">lats_for_mesh</span> <span class="o">=</span> <span class="n">lats_downsampled</span>  <span class="c1"># Use coords as-is</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Latitude coordinates are descending, using data as-is&quot;</span><span class="p">)</span>

        <span class="c1"># Create the plot with cartopy for better geographic visualization</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
        
        <span class="c1"># Determine appropriate projection based on data extent</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">lons_downsampled</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lons_downsampled</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Use Plate Carree for global data, or appropriate regional projection</span>
        <span class="k">if</span> <span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>  <span class="c1"># Global or near-global data</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Regional data</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
        
        <span class="c1"># Set map extent</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        
        <span class="c1"># Add natural earth features</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Plot the data using pcolormesh for better geographic accuracy</span>
        <span class="c1"># Use the appropriate latitude coordinates based on whether data was flipped</span>
        <span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons_downsampled</span><span class="p">,</span> <span class="n">lats_for_mesh</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">,</span> <span class="n">values_display</span><span class="p">,</span> 
                           <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> 
                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add colorbar</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        
        <span class="c1"># Add gridlines</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Set title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> Raster&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># Create a temporary directory for images (not in assets)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;temp_images&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Save the image to temp directory with higher DPI</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;raster_</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                   <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Convert to base64 for display in the web app</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image_file</span><span class="p">:</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">image_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        
        <span class="n">image_src</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">image_data</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster image converted to base64 successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_src</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_world_map_with_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a world map with data overlay on a Mapbox 3D globe&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating world map with overlay...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_mapbox_globe</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>

        <span class="c1"># Sample the data for better performance while maintaining quality</span>
        <span class="c1"># Use the same step size for both dimensions to ensure matching shapes</span>
        <span class="n">max_dim_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sample_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim_size</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampling data with step </span><span class="si">{</span><span class="n">sample_step</span><span class="si">}</span><span class="s2"> for 3D globe visualization&quot;</span><span class="p">)</span>
        
        <span class="n">lats_sampled</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">]</span>
        <span class="n">lons_sampled</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">]</span>
        <span class="n">values_sampled</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">,</span> <span class="p">::</span><span class="n">sample_step</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampled shapes - lats: </span><span class="si">{</span><span class="n">lats_sampled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, lons: </span><span class="si">{</span><span class="n">lons_sampled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, values: </span><span class="si">{</span><span class="n">values_sampled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a 3D scatter plot that will appear on the globe surface</span>
        <span class="c1"># Convert lat/lon to 3D coordinates on a unit sphere</span>
        <span class="n">lats_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lats_sampled</span><span class="p">)</span>
        <span class="n">lons_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lons_sampled</span><span class="p">)</span>
        
        <span class="c1"># Create meshgrid to ensure proper broadcasting</span>
        <span class="n">lats_mesh</span><span class="p">,</span> <span class="n">lons_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">,</span> <span class="n">lons_rad</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        
        <span class="c1"># 3D coordinates on unit sphere (radius = 1)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lats_mesh</span><span class="p">)</span>
        
        <span class="c1"># Flatten arrays for scatter plot</span>
        <span class="n">x_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_flat</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">z_flat</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">values_flat</span> <span class="o">=</span> <span class="n">values_sampled</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="c1"># Filter out NaN values</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values_flat</span><span class="p">)</span>
        <span class="n">x_valid</span> <span class="o">=</span> <span class="n">x_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">z_valid</span> <span class="o">=</span> <span class="n">z_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">values_valid</span> <span class="o">=</span> <span class="n">values_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid 3D data points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values_valid</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># First, add the Earth globe surface</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding Earth globe surface...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a basic Earth sphere with landmasses</span>
        <span class="c1"># Generate a sphere with more points for better appearance</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">phi_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        
        <span class="c1"># Convert to Cartesian coordinates</span>
        <span class="n">earth_radius</span> <span class="o">=</span> <span class="mf">0.98</span>  <span class="c1"># Slightly smaller than data points</span>
        <span class="n">x_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        <span class="n">y_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        <span class="n">z_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span>
        
        <span class="c1"># Add the Earth surface</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_earth</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_earth</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">z_earth</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Earth&#39;</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Earth Surface&#39;</span>
        <span class="p">))</span>
        
        <span class="c1"># Create the 3D scatter plot on the globe</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_valid</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_valid</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">z_valid</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># Slightly larger for better visibility</span>
                <span class="n">color</span><span class="o">=</span><span class="n">values_valid</span><span class="p">,</span>
                <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span>
                    <span class="n">title_side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="n">thickness</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                    <span class="nb">len</span><span class="o">=</span><span class="mf">0.6</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values_valid</span><span class="p">],</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">variable_name</span>
        <span class="p">))</span>

        <span class="c1"># Update layout for 3D globe</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ðŸŒ </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> - 3D Globe Overlay&quot;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2c3e50&#39;</span><span class="p">),</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span>
            <span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">aspectmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                <span class="n">camera</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="c1"># Add annotations for better orientation</span>
                <span class="n">annotations</span><span class="o">=</span><span class="p">[</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;North Pole&quot;</span><span class="p">,</span>
                        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=-</span><span class="mf">1.1</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;South Pole&quot;</span><span class="p">,</span>
                        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="c1"># Add a note about progressive rendering</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;ðŸ’¡ Tip: Zoom in to see more detail. The globe shows sampled data for performance.&quot;</span><span class="p">,</span>
            <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">xanchor</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">),</span>
            <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(255,255,255,0.8)&quot;</span><span class="p">,</span>
            <span class="n">bordercolor</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="n">borderwidth</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D globe with raster overlay created successfully!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: Future enhancement - progressive rendering will show more detail on zoom&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_fallback_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a fallback plot for unexpected data shapes&quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">variable_name</span>
        <span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> Data Plot&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_white&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_improved_globe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an improved world map with deck.gl globe visualization&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating improved world map with deck.gl globe...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable: </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lat dim: </span><span class="si">{</span><span class="n">lat_dim</span><span class="si">}</span><span class="s2">, Lon dim: </span><span class="si">{</span><span class="n">lon_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data array shape: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if required packages are available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">pydeck</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pdk</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required packages not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Falling back to basic 3D globe...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fallback_3d_globe</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>

        <span class="c1"># Create the deck.gl view state</span>
        <span class="n">view_state</span> <span class="o">=</span> <span class="n">pdk</span><span class="o">.</span><span class="n">ViewState</span><span class="p">(</span>
            <span class="n">latitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">zoom</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pitch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">bearing</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Create basic layers first (fast loading)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 1. Base Earth layer with natural colors</span>
        <span class="n">earth_layer</span> <span class="o">=</span> <span class="n">pdk</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span>
            <span class="s2">&quot;GeoJsonLayer&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_earth_geojson</span><span class="p">(),</span>
            <span class="n">stroked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">get_fill_color</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>  <span class="c1"># Light gray for land</span>
            <span class="n">get_line_color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">pickable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">earth_layer</span><span class="p">)</span>

        <span class="c1"># 2. Ocean layer</span>
        <span class="n">ocean_layer</span> <span class="o">=</span> <span class="n">pdk</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span>
            <span class="s2">&quot;GeoJsonLayer&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ocean_geojson</span><span class="p">(),</span>
            <span class="n">stroked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">get_fill_color</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span>  <span class="c1"># Blue for water</span>
            <span class="n">get_line_color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">pickable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean_layer</span><span class="p">)</span>

        <span class="c1"># 3. Country boundaries - removed for now to focus on core functionality</span>

        <span class="c1"># 4. Add initial data overlay (coarse for fast loading)</span>
        <span class="n">data_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_data_overlay_progressive</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_layer</span><span class="p">:</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_layer</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Added initial data overlay layer&quot;</span><span class="p">)</span>

        <span class="c1"># Create the basic deck.gl deck first (fast)</span>
        <span class="n">basic_deck</span> <span class="o">=</span> <span class="n">pdk</span><span class="o">.</span><span class="n">Deck</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">initial_view_state</span><span class="o">=</span><span class="n">view_state</span><span class="p">,</span>
            <span class="n">map_style</span><span class="o">=</span><span class="s1">&#39;mapbox://styles/mapbox/satellite-v9&#39;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span>
        <span class="p">)</span>

        <span class="c1"># Convert to HTML component for Dash</span>
        <span class="n">basic_deck_html</span> <span class="o">=</span> <span class="n">basic_deck</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span>
        
        <span class="c1"># Create a Dash component that can be embedded</span>
        <span class="n">globe_component</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
            <span class="n">html</span><span class="o">.</span><span class="n">H3</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ðŸŒ </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> - Interactive Globe&quot;</span><span class="p">,</span> 
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;textAlign&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;marginBottom&#39;</span><span class="p">:</span> <span class="s1">&#39;20px&#39;</span><span class="p">}),</span>
            <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Iframe</span><span class="p">(</span>
                    <span class="n">srcDoc</span><span class="o">=</span><span class="n">basic_deck_html</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="s1">&#39;800px&#39;</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;borderRadius&#39;</span><span class="p">:</span> <span class="s1">&#39;10px&#39;</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;textAlign&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">}),</span>
            <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;ðŸ’¡ Tip: Use mouse wheel to zoom, drag to rotate, and right-click to pan.&quot;</span><span class="p">,</span>
                       <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;textAlign&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;fontSize&#39;</span><span class="p">:</span> <span class="s1">&#39;14px&#39;</span><span class="p">})</span>
            <span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;marginTop&#39;</span><span class="p">:</span> <span class="s1">&#39;10px&#39;</span><span class="p">})</span>
        <span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basic deck.gl globe created successfully!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">globe_component</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_data_overlay_progressive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add data overlay progressively to the existing globe&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding data overlay progressively...&quot;</span><span class="p">)</span>
        
        <span class="n">lats</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lat_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lon_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Get the geographic bounds</span>
        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Geographic bounds: lat [</span><span class="si">{</span><span class="n">lat_min</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lat_max</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">], lon [</span><span class="si">{</span><span class="n">lon_min</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lon_max</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="c1"># Start with very coarse sampling for initial view</span>
        <span class="n">max_dim_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">initial_sample_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim_size</span> <span class="o">//</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># Very coarse for fast initial load</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial sampling with step </span><span class="si">{</span><span class="n">initial_sample_step</span><span class="si">}</span><span class="s2"> for fast loading&quot;</span><span class="p">)</span>
        
        <span class="n">lats_sampled</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[::</span><span class="n">initial_sample_step</span><span class="p">]</span>
        <span class="n">lons_sampled</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[::</span><span class="n">initial_sample_step</span><span class="p">]</span>
        <span class="n">values_sampled</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="n">initial_sample_step</span><span class="p">,</span> <span class="p">::</span><span class="n">initial_sample_step</span><span class="p">]</span>
        
        <span class="c1"># Create initial data points</span>
        <span class="n">data_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lats_sampled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lons_sampled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values_sampled</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]):</span>
                    <span class="n">data_points</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lats_sampled</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lons_sampled</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">values_sampled</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                    <span class="p">})</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_points</span><span class="p">)</span><span class="si">}</span><span class="s2"> initial data points&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a simple data overlay layer</span>
        <span class="k">if</span> <span class="n">data_points</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">pydeck</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pdk</span>
                
                <span class="n">data_layer</span> <span class="o">=</span> <span class="n">pdk</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span>
                    <span class="s2">&quot;ScatterplotLayer&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">data_points</span><span class="p">,</span>
                    <span class="n">get_position</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
                    <span class="n">get_color</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="n">get_radius</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>  <span class="c1"># 20km radius for coarse view</span>
                    <span class="n">pickable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">stroked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">radius_scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">radius_min_pixels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">radius_max_pixels</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">color_range</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>  <span class="c1"># Blue to Green to Red</span>
                    <span class="n">color_domain</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">data_points</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">data_points</span><span class="p">)]</span>
                <span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data overlay layer created successfully!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data_layer</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create data overlay: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_coastline_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">continent_type</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create realistic continent outlines using actual geographic shapes&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">continent_type</span> <span class="o">==</span> <span class="s1">&#39;north_america&#39;</span><span class="p">:</span>
                <span class="c1"># North America - more realistic shape</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span> <span class="o">-</span><span class="mi">130</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">130</span><span class="p">,</span> <span class="o">-</span><span class="mi">140</span><span class="p">]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">continent_type</span> <span class="o">==</span> <span class="s1">&#39;europe_asia&#39;</span><span class="p">:</span>
                <span class="c1"># Europe/Asia - more realistic shape</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mi">70</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">continent_type</span> <span class="o">==</span> <span class="s1">&#39;africa&#39;</span><span class="p">:</span>
                <span class="c1"># Africa - more realistic shape</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mi">35</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">35</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">continent_type</span> <span class="o">==</span> <span class="s1">&#39;south_america&#39;</span><span class="p">:</span>
                <span class="c1"># South America - more realistic shape</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">continent_type</span> <span class="o">==</span> <span class="s1">&#39;australia&#39;</span><span class="p">:</span>
                <span class="c1"># Australia - more realistic shape</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">110</span><span class="p">]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">]</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># Convert to radians</span>
            <span class="n">lons_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
            <span class="n">lats_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            
            <span class="c1"># Convert to 3D coordinates</span>
            <span class="n">x_coast</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lons_rad</span><span class="p">)</span>
            <span class="n">y_coast</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lons_rad</span><span class="p">)</span>
            <span class="n">z_coast</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">)</span>
            
            <span class="c1"># Create a line trace for the coastline</span>
            <span class="k">return</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_coast</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_coast</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">z_coast</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgb(100, 150, 50)&#39;</span><span class="p">,</span>  <span class="c1"># Green land color</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">),</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;skip&#39;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create coastline outline: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_fallback_3d_globe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback to basic 3D globe if deck.gl is not available&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating fallback 3D globe...&quot;</span><span class="p">)</span>
        
        <span class="n">lats</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lat_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lon_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Sample the data for better performance</span>
        <span class="n">max_dim_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sample_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim_size</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="n">lats_sampled</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">]</span>
        <span class="n">lons_sampled</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">]</span>
        <span class="n">values_sampled</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">,</span> <span class="p">::</span><span class="n">sample_step</span><span class="p">]</span>
        
        <span class="c1"># Create a 3D scatter plot on a sphere</span>
        <span class="n">lats_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lats_sampled</span><span class="p">)</span>
        <span class="n">lons_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lons_sampled</span><span class="p">)</span>
        
        <span class="n">lats_mesh</span><span class="p">,</span> <span class="n">lons_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">,</span> <span class="n">lons_rad</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lats_mesh</span><span class="p">)</span>
        
        <span class="n">x_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_flat</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">z_flat</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">values_flat</span> <span class="o">=</span> <span class="n">values_sampled</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values_flat</span><span class="p">)</span>
        <span class="n">x_valid</span> <span class="o">=</span> <span class="n">x_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">z_valid</span> <span class="o">=</span> <span class="n">z_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">values_valid</span> <span class="o">=</span> <span class="n">values_flat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        
        <span class="c1"># Add Earth surface with realistic oceans and land</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">phi_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        
        <span class="n">earth_radius</span> <span class="o">=</span> <span class="mf">0.98</span>
        <span class="n">x_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        <span class="n">y_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        <span class="n">z_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span>
        
        <span class="c1"># Create a fast, realistic Earth using simple vector overlays</span>
        <span class="c1"># Start with a clean blue ocean base</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_earth</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_earth</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">z_earth</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;blues&#39;</span><span class="p">,</span>  <span class="c1"># Simple blue ocean</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ocean Base&#39;</span>
        <span class="p">))</span>
        
        <span class="c1"># Add continent outlines using realistic geographic shapes</span>
        <span class="c1"># North America coastline</span>
        <span class="n">na_coast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coastline_outline</span><span class="p">(</span><span class="s1">&#39;north_america&#39;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">na_coast</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">na_coast</span><span class="p">)</span>
        
        <span class="c1"># Europe/Asia coastline</span>
        <span class="n">eu_coast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coastline_outline</span><span class="p">(</span><span class="s1">&#39;europe_asia&#39;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eu_coast</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">eu_coast</span><span class="p">)</span>
        
        <span class="c1"># Africa coastline</span>
        <span class="n">af_coast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coastline_outline</span><span class="p">(</span><span class="s1">&#39;africa&#39;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">af_coast</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">af_coast</span><span class="p">)</span>
        
        <span class="c1"># South America coastline</span>
        <span class="n">sa_coast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coastline_outline</span><span class="p">(</span><span class="s1">&#39;south_america&#39;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sa_coast</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">sa_coast</span><span class="p">)</span>
        
        <span class="c1"># Australia</span>
        <span class="n">au_coast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_coastline_outline</span><span class="p">(</span><span class="s1">&#39;australia&#39;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">au_coast</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">au_coast</span><span class="p">)</span>
        
        <span class="c1"># Add data points</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_valid</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_valid</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">z_valid</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">values_valid</span><span class="p">,</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">title</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span>
                        <span class="n">title_side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                        <span class="n">thickness</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="nb">len</span><span class="o">=</span><span class="mf">0.6</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values_valid</span><span class="p">],</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">variable_name</span>
            <span class="p">))</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ðŸŒ </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> - Enhanced 3D Globe&quot;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2c3e50&#39;</span><span class="p">),</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span>
            <span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]),</span>
                <span class="n">aspectmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                <span class="n">camera</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="p">),</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_mapbox_globe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Mapbox 3D globe with data overlay&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating Mapbox 3D globe...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load Mapbox API token from environment file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
            
            <span class="c1"># Load the Mapbox API token from the credentials file</span>
            <span class="n">creds_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;creds&#39;</span><span class="p">,</span> <span class="s1">&#39;mapboxapi.env&#39;</span><span class="p">)</span>
            <span class="n">load_dotenv</span><span class="p">(</span><span class="n">creds_path</span><span class="p">)</span>
            
            <span class="n">mapbox_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAPBOX_API_TOKEN&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapbox_token</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: MAPBOX_API_TOKEN not found, falling back to basic globe&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fallback_3d_globe</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>
                
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapbox API token loaded successfully&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading Mapbox token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, falling back to basic globe&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fallback_3d_globe</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">lat_dim</span><span class="p">,</span> <span class="n">lon_dim</span><span class="p">)</span>
        
        <span class="n">lats</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lat_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">lon_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Get geographic bounds</span>
        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="c1"># Sample data for performance</span>
        <span class="n">max_dim_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sample_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_dim_size</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="n">lats_sampled</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">]</span>
        <span class="n">lons_sampled</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">]</span>
        <span class="n">values_sampled</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="n">sample_step</span><span class="p">,</span> <span class="p">::</span><span class="n">sample_step</span><span class="p">]</span>
        
        <span class="c1"># Create data points for overlay</span>
        <span class="n">data_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lats_sampled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lons_sampled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values_sampled</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]):</span>
                    <span class="n">data_points</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lats_sampled</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lons_sampled</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">values_sampled</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                    <span class="p">})</span>
        
        <span class="c1"># Create a 3D globe figure using Plotly&#39;s built-in 3D projection</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        
        <span class="c1"># Add the data as a 3D scatter plot on a sphere</span>
        <span class="k">if</span> <span class="n">data_points</span><span class="p">:</span>
            <span class="c1"># Convert lat/lon to 3D coordinates on a sphere</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">z_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">data_points</span><span class="p">:</span>
                <span class="n">lat_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span>
                <span class="n">lon_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
                
                <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon_rad</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon_rad</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span>
                
                <span class="n">x_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">y_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">z_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_coords</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_coords</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">z_coords</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                    <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">variable_name</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">variable_name</span>
            <span class="p">))</span>
        
        <span class="c1"># Add a base Earth sphere with Mapbox satellite texture</span>
        <span class="c1"># Create a sphere surface</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">phi_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        
        <span class="n">earth_radius</span> <span class="o">=</span> <span class="mf">0.98</span>
        <span class="n">x_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        <span class="n">y_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        <span class="n">z_earth</span> <span class="o">=</span> <span class="n">earth_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span>
        
        <span class="c1"># Add Earth surface with realistic colors</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_earth</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_earth</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">z_earth</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;earth&#39;</span><span class="p">,</span>  <span class="c1"># Use Plotly&#39;s built-in Earth colorscale</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Earth Surface&#39;</span>
        <span class="p">))</span>
        
        <span class="c1"># Configure the 3D scene for globe view</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ðŸŒ </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> - Globe&quot;</span><span class="p">,</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]),</span>
                <span class="n">aspectmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                <span class="n">camera</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapbox 3D globe created successfully!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_earth_geojson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get realistic Earth landmasses GeoJSON&quot;&quot;&quot;</span>
        <span class="c1"># More realistic continent boundaries</span>
        <span class="n">earth_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;North America&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;South America&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Europe&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Africa&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Asia&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Australia&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">155</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">155</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Antarctica&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">earth_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ocean_geojson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get realistic ocean GeoJSON with major ocean basins&quot;&quot;&quot;</span>
        <span class="n">ocean_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Pacific Ocean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Atlantic Ocean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Indian Ocean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Arctic Ocean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span>
                            <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
                        <span class="p">]]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ocean_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_countries_geojson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get country boundaries GeoJSON from Natural Earth data&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to fetch from Natural Earth (free, public domain)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson&quot;</span>
            <span class="c1"># Use the global requests import</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch countries data: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_simple_countries_geojson</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching countries data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_simple_countries_geojson</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_simple_countries_geojson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback simple country boundaries&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Continents&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="c1"># Simplified continent boundaries</span>
                            <span class="p">[[[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]]],</span>  <span class="c1"># South America</span>
                            <span class="p">[[[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]],</span>      <span class="c1"># North America</span>
                            <span class="p">[[[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]],</span>           <span class="c1"># Europe/Asia</span>
                            <span class="p">[[[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]],</span>            <span class="c1"># Asia</span>
                            <span class="p">[[[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]]],</span>       <span class="c1"># Africa</span>
                            <span class="p">[[[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]]]</span>         <span class="c1"># Australia</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_enhanced_earth_texture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an enhanced Earth texture with realistic land/water patterns&quot;&quot;&quot;</span>
        <span class="c1"># This creates a more realistic Earth appearance with elevation-based coloring</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        
        <span class="c1"># Create a high-resolution grid for the Earth surface</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>  <span class="c1"># Longitude</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>  <span class="c1"># Latitude</span>
        
        <span class="n">phi_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        
        <span class="c1"># Convert to degrees for easier calculations</span>
        <span class="n">lat_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">theta_mesh</span><span class="p">)</span>
        <span class="n">lon_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">phi_mesh</span><span class="p">)</span>
        
        <span class="c1"># Create elevation-based coloring</span>
        <span class="c1"># Simulate continents and oceans based on latitude/longitude patterns</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lat_deg</span><span class="p">)</span>
        
        <span class="c1"># North America (rough approximation)</span>
        <span class="n">na_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">170</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">na_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># Land elevation</span>
        
        <span class="c1"># South America</span>
        <span class="n">sa_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">55</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">sa_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Europe</span>
        <span class="n">eu_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="mi">35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">eu_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Africa</span>
        <span class="n">af_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="mi">35</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">af_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Asia</span>
        <span class="n">asia_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">asia_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Australia</span>
        <span class="n">aus_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">&lt;=</span> <span class="mi">155</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">45</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">aus_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Antarctica</span>
        <span class="n">ant_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_deg</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">elevation</span><span class="p">[</span><span class="n">ant_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># Higher elevation for ice</span>
        
        <span class="c1"># Add some noise for more realistic appearance</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># For reproducible results</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">elevation</span> <span class="o">+=</span> <span class="n">noise</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">elevation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">phi_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span><span class="p">,</span> <span class="n">elevation</span></div>



<span class="c1"># Legacy classes for backward compatibility (can be removed later)</span>
<div class="viewcode-block" id="DataQuickStats">
<a class="viewcode-back" href="../api.html#data.DataQuickStats">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataQuickStats</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy class - use DataManager instead&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">ds_getter</span><span class="p">,</span> <span class="n">dataseturl_getter</span><span class="p">,</span> <span class="n">dataset_engine_getter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span> <span class="o">=</span> <span class="n">DataManager</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">ds_getter</span><span class="p">)</span>

<div class="viewcode-block" id="DataQuickStats.setup_callbacks">
<a class="viewcode-back" href="../api.html#data.DataQuickStats.setup_callbacks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">setup_callbacks</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="DataSubsetter">
<a class="viewcode-back" href="../api.html#data.DataSubsetter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataSubsetter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy class - use DataManager instead&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>

<div class="viewcode-block" id="DataSubsetter.subset_data">
<a class="viewcode-back" href="../api.html#data.DataSubsetter.subset_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">subset_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">,</span> <span class="n">user_selection</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># This functionality is now in DataManager._get_subsetted_data</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="DataPlot">
<a class="viewcode-back" href="../api.html#data.DataPlot">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataPlot</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy class - use DataManager instead&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">dimension_selection</span><span class="p">,</span> <span class="n">dataseturl_getter</span><span class="p">,</span> <span class="n">dataset_engine_getter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span> <span class="o">=</span> <span class="n">DataManager</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">data_array</span><span class="p">)</span>

<div class="viewcode-block" id="DataPlot.setup_callbacks">
<a class="viewcode-back" href="../api.html#data.DataPlot.setup_callbacks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">setup_callbacks</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>